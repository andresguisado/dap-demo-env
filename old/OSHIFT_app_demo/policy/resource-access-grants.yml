---

##################
# Grant application layers access to k8s-secrets
- !permit
  privileges: [ read, execute ]
  roles:
  - !layer cust-portal/webservers
  resources:
  - !variable k8s-secrets/app-username
  - !variable k8s-secrets/app-apikey

- !permit
  privileges: [ read, execute ]
  roles:
  - !layer cust-portal/appservers
  resources:
  - !variable k8s-secrets/db-username
  - !variable k8s-secrets/db-password

##################
# Grant CICD_Secrets consumer role to appservers
- !grant
  role: !group DemoVault/CICD/CICD_Secrets/delegation/consumers
  member: !layer cust-portal/appservers

##################
# Define variables for secretless access
- !policy
  id: test-app-secretless
  annotations:
    description: This policy defines the required creds to access DBs

  body:
    - &secretless-variables
      - !variable pg-address
      - !variable pg-username
      - !variable pg-password
      - !variable pg-sslmode
      - !variable mysql-host
      - !variable mysql-port
      - !variable mysql-username
      - !variable mysql-password
      - !variable mysql-sslmode
      - !variable http-username
      - !variable http-password

    - !permit
      role: !layer /cust-portal/secretless
      privileges: [ read, execute ]
      resources: *secretless-variables

- !permit
  role: !layer /cust-portal/secretless
  privileges: [ read, execute ]
  resources: !variable DemoVault/CICD/CICD_Secrets/SSH-minikube/password
