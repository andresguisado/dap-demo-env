---
- !policy
  id: {{ TEST_APP_NAMESPACE_NAME }}
  annotations:
    description: This policy defines the identity structure for the application
  body:
  - !layer webservers
  - !layer appservers
  - !layer secretless

# add authn identity layer to application layer so authn role inherits app's permissions
- !grant
  role: !layer {{ TEST_APP_NAMESPACE_NAME }}/webservers
  members:
  - !host /conjur/authn-k8s/{{ AUTHENTICATOR_ID }}/apps/{{ TEST_APP_NAMESPACE_NAME }}/service_account/ocp-webserver
  - !host /conjur/authn-k8s/{{ AUTHENTICATOR_ID }}/apps/{{ TEST_APP_NAMESPACE_NAME }}/service_account/k8s-webserver

- !grant
  role: !layer {{ TEST_APP_NAMESPACE_NAME }}/appservers
  members:
  - !host /conjur/authn-k8s/{{ AUTHENTICATOR_ID }}/apps/{{ TEST_APP_NAMESPACE_NAME }}/service_account/ocp-appserver
  - !host /conjur/authn-k8s/{{ AUTHENTICATOR_ID }}/apps/{{ TEST_APP_NAMESPACE_NAME }}/service_account/k8s-appserver

- !grant
  role: !layer {{ TEST_APP_NAMESPACE_NAME }}/secretless
  members:
  - !host /conjur/authn-k8s/{{ AUTHENTICATOR_ID }}/apps/{{ TEST_APP_NAMESPACE_NAME }}/service_account/ocp-secretless-broker
  - !host /conjur/authn-k8s/{{ AUTHENTICATOR_ID }}/apps/{{ TEST_APP_NAMESPACE_NAME }}/service_account/k8s-secretless-broker

